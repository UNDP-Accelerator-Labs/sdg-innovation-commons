name: Multi-Container Sidecar Deployment

on:
  push:
    tags:
      - 'sidecar-v*'  # Use different tag pattern to avoid conflicts

jobs:
  build_pipeline:
    name: Build Images
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --prune --unshallow --tags --force

      - name: Docker login
        uses: azure/docker-login@v2
        with:
          login-server: acclabdocker.azurecr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Enable corepack and pnpm
        run: |
          set -e
          npm install -g corepack@latest
          corepack enable || true
          corepack prepare pnpm@latest --activate || true

      - name: Set env
        run: echo "IMAGE_TAG=$(make -s name)" >> $GITHUB_ENV

      - name: Build and push main app image
        run: |
          make -s build
          make -s dockerpush

      - name: Build and push worker image
        run: |
          docker build -f deploy/Dockerfile.worker -t acclabdocker.azurecr.io/sdginnovationcommons-worker:${{ env.IMAGE_TAG }} .
          docker push acclabdocker.azurecr.io/sdginnovationcommons-worker:${{ env.IMAGE_TAG }}

  deploy_multicontainer_staging:
    name: Deploy Multi-Container to Staging
    needs: build_pipeline
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --prune --unshallow --tags --force

      - name: Set env
        run: echo "IMAGE_TAG=$(make -s name)" >> $GITHUB_ENV

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create docker-compose configuration
        run: |
          cat > docker-compose.staging.yml <<EOF
          version: '3.8'

          services:
            web:
              image: acclabdocker.azurecr.io/sdginnovationcommons:${{ env.IMAGE_TAG }}
              ports:
                - "80:3000"
                - "443:3000"
              environment:
                - PORT=3000
                - NODE_ENV=production
                - HOSTNAME=0.0.0.0
              restart: always

            worker:
              image: acclabdocker.azurecr.io/sdginnovationcommons-worker:${{ env.IMAGE_TAG }}
              ports:
                - "8080:80"
              environment:
                - NODE_ENV=production
                - PORT=80
                - WEBJOB_HEARTBEAT_FILE=/app/scripts/worker.heartbeat.json
              restart: always
              depends_on:
                - web
          EOF

      - name: Configure multi-container deployment
        run: |
          az webapp config container set \
            --name staging-sdg-innovation-commons \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --multicontainer-config-type compose \
            --multicontainer-config-file docker-compose.staging.yml

      - name: Restart App Service
        run: |
          az webapp restart \
            --name staging-sdg-innovation-commons \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

      - name: Show deployment info
        run: |
          echo "âœ… Deployed multi-container to staging"
          echo "Main app: acclabdocker.azurecr.io/sdginnovationcommons:${{ env.IMAGE_TAG }}"
          echo "Worker: acclabdocker.azurecr.io/sdginnovationcommons-worker:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ðŸ” View logs:"
          echo "  az webapp log tail --name staging-sdg-innovation-commons --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}"
          echo ""
          echo "ðŸŒ Staging URL: https://staging-sdg-innovation-commons.azurewebsites.net"
