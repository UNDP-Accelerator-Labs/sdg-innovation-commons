name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger on version tags
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  NAMESPACE: default

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Next.js image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sdg-nextjs:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/sdg-nextjs:latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/sdg-nextjs:latest
          cache-to: type=inline

      - name: Build and push Semantic Search image
        uses: docker/build-push-action@v5
        with:
          context: ./semantic-search
          file: ./semantic-search/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sdg-semantic-search:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/sdg-semantic-search:latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/sdg-semantic-search:latest
          cache-to: type=inline

      - name: Build and push Worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/Dockerfile.worker
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sdg-worker:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/sdg-worker:latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/sdg-worker:latest
          cache-to: type=inline

      - name: Build and push Embedding Worker image
        uses: docker/build-push-action@v5
        with:
          context: ./semantic-search
          file: ./semantic-search/Dockerfile.worker
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sdg-embedding-worker:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/sdg-embedding-worker:latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/sdg-embedding-worker:latest
          cache-to: type=inline

      - name: Set up Azure CLI
        uses: azure/setup-kubectl@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Install NGINX Ingress Controller
        run: |
          echo "ğŸ“¦ Installing NGINX Ingress Controller..."
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
          helm repo update
          
          # Install or upgrade NGINX Ingress
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz \
            --wait \
            --timeout 5m || echo "NGINX Ingress already installed"
          
          echo "âœ… NGINX Ingress Controller ready"

      - name: Install cert-manager for SSL
        run: |
          echo "ğŸ“¦ Installing cert-manager..."
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml || echo "cert-manager already installed"
          
          # Wait for cert-manager to be ready
          echo "â³ Waiting for cert-manager..."
          kubectl wait --for=condition=Available --timeout=300s \
            deployment/cert-manager \
            deployment/cert-manager-webhook \
            deployment/cert-manager-cainjector \
            -n cert-manager || echo "cert-manager pods not ready yet"
          
          echo "âœ… cert-manager ready"

      - name: Create/Update Next.js ConfigMap
        run: |
          kubectl create configmap nextjs-config \
            --from-literal=NODE_ENV="production" \
            --from-literal=PORT="3000" \
            --from-literal=LOG_LEVEL="INFO" \
            --from-literal=QDRANT_HOST="qdrant-service" \
            --from-literal=QDRANT_PORT="6333" \
            --from-literal=QDRANT_USE_HTTPS="false" \
            --from-literal=REDIS_HOST="redis-service" \
            --from-literal=REDIS_PORT="6379" \
            --from-literal=SEMANTIC_SEARCH_URL="http://semantic-search-service:8000" \
            --from-literal=WORKER_CONCURRENCY="2" \
            --from-literal=WORKER_INTERVAL="60" \
            --from-literal=NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
            --from-literal=API_HOST="0.0.0.0" \
            --from-literal=API_PORT="3000" \
            --from-literal=ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update Next.js Secrets
        run: |
          kubectl create secret generic nextjs-secrets \
            --from-literal=DATABASE_URL='${{ secrets.DATABASE_URL }}' \
            --from-literal=APP_SECRET='${{ secrets.APP_SECRET }}' \
            --from-literal=NEXTAUTH_SECRET='${{ secrets.NEXTAUTH_SECRET }}' \
            --from-literal=GENERAL_DB_PASSWORD='${{ secrets.GENERAL_DB_PASSWORD }}' \
            --from-literal=QDRANT_API_KEY='${{ secrets.QDRANT_API_KEY }}' \
            --from-literal=REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}' \
            --from-literal=SEMANTIC_SEARCH_API_KEY='${{ secrets.SEMANTIC_SEARCH_API_KEY }}' \
            --from-literal=AZURE_STORAGE_CONNECTION_STRING='${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}' \
            --from-literal=SMTP_HOST='${{ secrets.SMTP_HOST }}' \
            --from-literal=SMTP_PORT='${{ secrets.SMTP_PORT }}' \
            --from-literal=SMTP_USER='${{ secrets.SMTP_USER }}' \
            --from-literal=SMTP_PASS='${{ secrets.SMTP_PASS }}' \
            --from-literal=ADMIN_EMAILS='${{ secrets.ADMIN_EMAILS }}' \
            --from-literal=OPENCAGE_API='${{ secrets.OPENCAGE_API }}' \
            --from-literal=ACCLAB_PLATFORM_KEY='${{ secrets.ACCLAB_PLATFORM_KEY }}' \
            --from-literal=BLOG_API_TOKEN='${{ secrets.BLOG_API_TOKEN }}' \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update Semantic Search ConfigMap
        run: |
          kubectl create configmap semantic-search-config \
            --from-literal=NODE_ENV="production" \
            --from-literal=LOG_LEVEL="INFO" \
            --from-literal=QDRANT_HOST="qdrant-service" \
            --from-literal=QDRANT_PORT="6333" \
            --from-literal=QDRANT_GRPC_PORT="6334" \
            --from-literal=QDRANT_COLLECTION_NAME="main" \
            --from-literal=QDRANT_USE_HTTPS="false" \
            --from-literal=EMBEDDING_MODEL="sentence-transformers/all-MiniLM-L6-v2" \
            --from-literal=DEVICE="cpu" \
            --from-literal=SERVICE_HOST="0.0.0.0" \
            --from-literal=SERVICE_PORT="8000" \
            --from-literal=REDIS_HOST="redis-service" \
            --from-literal=REDIS_PORT="6379" \
            --from-literal=GENERAL_DB_HOST="${{ secrets.GENERAL_DB_HOST }}" \
            --from-literal=GENERAL_DB_PORT="5432" \
            --from-literal=GENERAL_DB_USER="${{ secrets.GENERAL_DB_USER }}" \
            --from-literal=GENERAL_DB_NAME="${{ secrets.GENERAL_DB_NAME }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update Semantic Search Secrets
        run: |
          kubectl create secret generic semantic-search-secrets \
            --from-literal=QDRANT_API_KEY='${{ secrets.QDRANT_API_KEY }}' \
            --from-literal=API_SECRET_KEY='${{ secrets.SEMANTIC_SEARCH_API_KEY }}' \
            --from-literal=REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}' \
            --from-literal=GENERAL_DB_PASSWORD='${{ secrets.GENERAL_DB_PASSWORD }}' \
            --from-literal=BLOGS_DB_PASSWORD='${{ secrets.BLOGS_DB_PASSWORD }}' \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update Embedding Worker ConfigMap
        run: |
          kubectl create configmap embedding-worker-config \
            --from-literal=WORKER_CONCURRENCY="2" \
            --from-literal=WORKER_BATCH_SIZE="10" \
            --from-literal=LOG_LEVEL="INFO" \
            --from-literal=DEVICE="cpu" \
            --from-literal=EMBEDDING_MODEL="sentence-transformers/all-MiniLM-L6-v2" \
            --from-literal=REDIS_HOST="redis-service" \
            --from-literal=REDIS_PORT="6379" \
            --from-literal=QDRANT_HOST="qdrant-service" \
            --from-literal=QDRANT_PORT="6333" \
            --from-literal=QDRANT_GRPC_PORT="6334" \
            --from-literal=QDRANT_COLLECTION_NAME="main" \
            --from-literal=QDRANT_USE_HTTPS="false" \
            --from-literal=GENERAL_DB_HOST="${{ secrets.GENERAL_DB_HOST }}" \
            --from-literal=GENERAL_DB_PORT="5432" \
            --from-literal=GENERAL_DB_USER="${{ secrets.GENERAL_DB_USER }}" \
            --from-literal=GENERAL_DB_NAME="${{ secrets.GENERAL_DB_NAME }}" \
            --from-literal=BLOGS_DB_HOST="${{ secrets.BLOGS_DB_HOST }}" \
            --from-literal=BLOGS_DB_PORT="5432" \
            --from-literal=BLOGS_DB_USER="${{ secrets.BLOGS_DB_USER }}" \
            --from-literal=BLOGS_DB_NAME="${{ secrets.BLOGS_DB_NAME }}" \
            --from-literal=SEMANTIC_SEARCH_URL="http://semantic-search-service:8000" \
            --from-literal=APP_BASE_URL="${{ secrets.NEXTAUTH_URL }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update Embedding Worker Secrets
        run: |
          kubectl create secret generic embedding-worker-secrets \
            --from-literal=QDRANT_API_KEY='${{ secrets.QDRANT_API_KEY }}' \
            --from-literal=REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}' \
            --from-literal=GENERAL_DB_PASSWORD='${{ secrets.GENERAL_DB_PASSWORD }}' \
            --from-literal=BLOGS_DB_PASSWORD='${{ secrets.BLOGS_DB_PASSWORD }}' \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy infrastructure
        run: |
          # Deploy storage
          kubectl apply -f deploy/kubernetes/02-storage.yaml --namespace=${{ env.NAMESPACE }}
          
          # Deploy Qdrant
          kubectl apply -f deploy/kubernetes/03-qdrant.yaml --namespace=${{ env.NAMESPACE }}
          
          # Deploy Redis
          kubectl apply -f deploy/kubernetes/04-redis.yaml --namespace=${{ env.NAMESPACE }}
          
          # Wait for stateful services
          kubectl wait --for=condition=ready pod -l app=redis --timeout=300s --namespace=${{ env.NAMESPACE }} || true
          kubectl wait --for=condition=ready pod -l app=qdrant --timeout=300s --namespace=${{ env.NAMESPACE }} || true

      - name: Deploy applications
        run: |
          # Update image tags in manifests
          sed -i "s|image: .*sdg-nextjs.*|image: ${{ env.ACR_LOGIN_SERVER }}/sdg-nextjs:${{ github.sha }}|g" deploy/kubernetes/06-nextjs.yaml
          sed -i "s|image: .*sdg-semantic-search.*|image: ${{ env.ACR_LOGIN_SERVER }}/sdg-semantic-search:${{ github.sha }}|g" deploy/kubernetes/05-semantic-search.yaml
          sed -i "s|image: .*sdg-worker.*|image: ${{ env.ACR_LOGIN_SERVER }}/sdg-worker:${{ github.sha }}|g" deploy/kubernetes/07-worker.yaml
          sed -i "s|image: .*sdg-embedding-worker.*|image: ${{ env.ACR_LOGIN_SERVER }}/sdg-embedding-worker:${{ github.sha }}|g" deploy/kubernetes/12-embedding-worker.yaml
          
          # Deploy applications
          kubectl apply -f deploy/kubernetes/05-semantic-search.yaml --namespace=${{ env.NAMESPACE }}
          kubectl apply -f deploy/kubernetes/06-nextjs.yaml --namespace=${{ env.NAMESPACE }}
          kubectl apply -f deploy/kubernetes/07-worker.yaml --namespace=${{ env.NAMESPACE }}
          kubectl apply -f deploy/kubernetes/12-embedding-worker.yaml --namespace=${{ env.NAMESPACE }}
          kubectl apply -f deploy/kubernetes/09-qdrant-backup-cronjob.yaml --namespace=${{ env.NAMESPACE }}
          
          # Configure domain if provided
          if [ ! -z "${{ secrets.DOMAIN }}" ]; then
            echo "ğŸ”§ Configuring domain: ${{ secrets.DOMAIN }}"
            sed -i "s|YOUR_DOMAIN_HERE|${{ secrets.DOMAIN }}|g" deploy/kubernetes/08-ingress.yaml
            # Uncomment TLS and subdomain rules
            sed -i 's|^  # tls:|  tls:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  #   - hosts:|    - hosts:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  #   - |    - |g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  #   secretName:|    secretName:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^    # nginx.ingress.kubernetes.io/ssl-redirect:|    nginx.ingress.kubernetes.io/ssl-redirect:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^    # cert-manager.io/cluster-issuer:|    cert-manager.io/cluster-issuer:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  # - host:|  - host:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  #   http:|    http:|g' deploy/kubernetes/08-ingress.yaml
            sed -i 's|^  #     paths:|      paths:|g' deploy/kubernetes/08-ingress.yaml
            echo "âœ… Domain configuration applied"
          else
            echo "â„¹ï¸  Using IP-based access (no domain configured)"
          fi
          
          # Deploy ingress for external access
          kubectl apply -f deploy/kubernetes/08-ingress.yaml --namespace=${{ env.NAMESPACE }}

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/nextjs --timeout=600s --namespace=${{ env.NAMESPACE }}
          kubectl rollout status deployment/semantic-search --timeout=600s --namespace=${{ env.NAMESPACE }}
          kubectl rollout status deployment/worker --timeout=600s --namespace=${{ env.NAMESPACE }}
          kubectl rollout status deployment/embedding-worker --timeout=600s --namespace=${{ env.NAMESPACE }}

      - name: Report Access URLs
        run: |
          echo "â³ Waiting for LoadBalancer IP assignment..."
          sleep 30
          
          INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          if [ -z "$INGRESS_IP" ]; then
            echo "âš ï¸  LoadBalancer IP not yet assigned. Please wait a few minutes and check:"
            echo "    kubectl get svc -n ingress-nginx"
          else
            echo "âœ… Application deployed successfully!"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“ ACCESS YOUR APPLICATION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            if [ ! -z "${{ secrets.DOMAIN }}" ]; then
              # Domain configured - HTTPS access
              echo "ï¿½ MAIN SERVICES (Public Access)"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸŒ Main Application: https://${{ secrets.DOMAIN }}"
              echo "ğŸŒ WWW: https://www.${{ secrets.DOMAIN }}"
              echo ""
              echo "ğŸ”§ API & ADMIN SERVICES"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸ”§ Semantic Search API: https://api.${{ secrets.DOMAIN }}"
              echo "   â†³ Search Endpoint: https://api.${{ secrets.DOMAIN }}/search"
              echo "   â†³ Swagger Docs: https://api.${{ secrets.DOMAIN }}/docs"
              echo "   â†³ ReDoc: https://api.${{ secrets.DOMAIN }}/redoc"
              echo ""
              echo "ğŸ—„ï¸  Qdrant Dashboard: https://qdrant.${{ secrets.DOMAIN }}"
              echo "   â†³ Upload Snapshots: https://qdrant.${{ secrets.DOMAIN }}/dashboard"
              echo "   â†³ Collections: https://qdrant.${{ secrets.DOMAIN }}/collections"
              echo "   â†³ Authentication: api-key header with QDRANT_API_KEY"
              echo ""
              echo "ğŸ“Š MONITORING SERVICES"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸ“ˆ Prometheus: https://prometheus.${{ secrets.DOMAIN }}"
              echo "    (Metrics collection & queries)"
              echo "ğŸ“Š Grafana: https://grafana.${{ secrets.DOMAIN }}"
              echo "    (Visualization dashboards)"
              echo ""
              echo "ğŸ“‹ DNS Configuration Required:"
              echo "   Point these A records to: $INGRESS_IP"
              echo "   â€¢ @ (root domain)"
              echo "   â€¢ www"
              echo "   â€¢ api"
              echo "   â€¢ qdrant"
              echo "   â€¢ prometheus"
              echo "   â€¢ grafana"
              echo "   Or use wildcard: *.${{ secrets.DOMAIN }} â†’ $INGRESS_IP"
              echo ""
              echo "ğŸ”’ SSL Certificate: Let's Encrypt (auto-configured)"
              echo "   Check: kubectl get certificate -n ${{ env.NAMESPACE }}"
              echo "   Auto-renewal: 30 days before expiration"
            else
              # IP-based access
              echo "ğŸŒ MAIN SERVICES (Public Access)"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸŒ Main Application: http://$INGRESS_IP"
              echo ""
              echo "ğŸ”§ API & ADMIN SERVICES"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸ”§ Semantic Search API: http://$INGRESS_IP/api/semantic"
              echo "   â†³ Search Endpoint: http://$INGRESS_IP/api/semantic/search"
              echo "   â†³ Swagger Docs: http://$INGRESS_IP/api/semantic/docs"
              echo "   â†³ ReDoc: http://$INGRESS_IP/api/semantic/redoc"
              echo ""
              echo "ğŸ—„ï¸  Qdrant Dashboard: http://$INGRESS_IP/qdrant"
              echo "   â†³ Upload Snapshots: http://$INGRESS_IP/qdrant/dashboard"
              echo "   â†³ Collections: http://$INGRESS_IP/qdrant/collections"
              echo "   â†³ Authentication: api-key header with QDRANT_API_KEY"
              echo ""
              echo "ğŸ“Š MONITORING SERVICES"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸ“ˆ Prometheus: http://$INGRESS_IP/prometheus"
              echo "    (Metrics collection & queries)"
              echo "ğŸ“Š Grafana: http://$INGRESS_IP/grafana"
              echo "    (Visualization dashboards)"
              echo ""
              echo "ğŸ“ To enable domain & HTTPS:"
              echo "   1. Add DOMAIN secret in GitHub Settings"
              echo "   2. Configure DNS A records â†’ $INGRESS_IP"
              echo "   3. Redeploy (Let's Encrypt SSL auto-configured)"
            fi
            
            echo ""
            echo "ğŸ” SECURITY NOTES:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "â€¢ Qdrant: API key authentication enabled"
            echo "â€¢ Prometheus: Add basic auth for production use"
            echo "â€¢ Grafana: Default credentials - change immediately!"
            echo ""
            echo "ğŸ’¡ USEFUL COMMANDS:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "# Port forward for local access:"
            echo "kubectl port-forward -n ${{ env.NAMESPACE }} service/qdrant-service 6333:6333"
            echo "kubectl port-forward -n ${{ env.NAMESPACE }} service/prometheus-service 9090:9090"
            echo "kubectl port-forward -n ${{ env.NAMESPACE }} service/grafana-service 3001:3001"
            echo ""
            echo "# Check pod status:"
            echo "kubectl get pods -n ${{ env.NAMESPACE }}"
            echo ""
            echo "# View logs:"
            echo "kubectl logs -f -n ${{ env.NAMESPACE }} deployment/nextjs"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "==================================="
          echo "Deployment Summary"
          echo "==================================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods --namespace=${{ env.NAMESPACE }}
          echo ""
          echo "=== Services ==="
          kubectl get svc --namespace=${{ env.NAMESPACE }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs above for details"
          kubectl get events --namespace=${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -20
