# Local Development Docker Compose
# Infrastructure services (Qdrant, Redis) for local development
# Run Next.js, Semantic Search, and Worker locally for hot reload
#
# Usage:
#   make dev-infra    # Start only infrastructure
#   make dev-nextjs   # Start Next.js with hot reload (after dev-infra)
#   make dev-semantic # Start semantic search with hot reload (after dev-infra)
#
# Note: Uses Azure PostgreSQL - configure DATABASE_URL in .env
# DATABASE_URL="postgresql://user:password@servername.postgres.database.azure.com:5432/dbname?sslmode=require"

services:
  # PostgreSQL: Using Azure PostgreSQL Flexible Server
  # Application connects directly to Azure - no local postgres service needed

  # Qdrant Vector Database
  # Persistent storage is CRITICAL - data survives container restarts
  qdrant:
    image: qdrant/qdrant:latest
    container_name: sdg-qdrant-dev
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API (optional, for high-performance clients)
    volumes:
      # CRITICAL: Named volume ensures vector data persists across container lifecycles
      - qdrant_dev_storage:/qdrant/storage
      # Optional: Snapshots directory for backups
      - qdrant_dev_snapshots:/qdrant/snapshots
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:-dev-secret-key}
      - QDRANT__SERVICE__ENABLE_TLS=false
      # Optional: Configure storage
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      # Performance tuning (optional)
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=100
    networks:
      - sdg-dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: sdg-redis-dev
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-devpassword} --appendonly yes
    volumes:
      # Persistent storage for Redis data
      - redis_dev_data:/data
    networks:
      - sdg-dev-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "--no-auth-warning",
          "-a",
          "${REDIS_PASSWORD:-devpassword}",
          "ping",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Embedding API
  # FastAPI service for semantic search and embedding management
  embedding-api:
    build:
      context: ../semantic-search
      dockerfile: Dockerfile
    container_name: sdg-embedding-api-dev
    env_file:
      - ../semantic-search/.env.development # API security & Qdrant config
      - ../.env.local # Database credentials
    ports:
      - "8000:8000"
    environment:
      # Redis configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword}
      - REDIS_DB=0

      # Queue configuration
      - EMBEDDING_QUEUE_NAME=embedding_jobs
      - BATCH_QUEUE_NAME=embedding_batch_jobs
      - DLQ_NAME=embedding_dlq

      # Qdrant configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-dev-secret-key}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-main}
      - QDRANT_USE_HTTPS=false

      # Embedding model
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - EMBEDDING_DIMENSION=384
      - DEVICE=cpu

      # API Security (loaded from env_file: semantic-search/.env.development)
      # Only override if needed:
      - ALLOWED_ORIGINS=http://localhost:3000

      # Application Base URL (for generating document URLs)
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}

      # Database (override host for Docker, rest from .env.local)
      - GENERAL_DB_HOST=host.docker.internal

      # Service configuration
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8000
      - LOG_LEVEL=INFO

    depends_on:
      - redis
      - qdrant

    extra_hosts:
      - "host.docker.internal:host-gateway"

    networks:
      - sdg-dev-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Embedding Worker
  # Processes documents from Redis queue
  # Scale with: docker-compose -f deploy/docker-compose.dev.yml up -d --scale embedding-worker=3
  embedding-worker:
    build:
      context: ../semantic-search
      dockerfile: Dockerfile.worker
    container_name: sdg-embedding-worker-dev
    env_file:
      - ../semantic-search/.env.development # API security & Qdrant config
      - ../.env.local # Database credentials
    environment:
      # Redis configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword}
      - REDIS_DB=0

      # Queue configuration
      - EMBEDDING_QUEUE_NAME=embedding_jobs
      - BATCH_QUEUE_NAME=embedding_batch_jobs
      - DLQ_NAME=embedding_dlq
      - WORKER_BATCH_SIZE=10
      - MAX_RETRIES=3
      - JOB_TIMEOUT=300
      - POLL_INTERVAL=1.0

      # Qdrant configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-dev-secret-key}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-main}

      # Embedding model
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - DEVICE=cpu

      # Application Base URL (for generating document URLs)
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}

      # Database (loaded from .env.local via env_file, override host for Docker)
      - GENERAL_DB_HOST=host.docker.internal

      # Logging
      - LOG_LEVEL=INFO

    depends_on:
      - redis
      - qdrant

    extra_hosts:
      - "host.docker.internal:host-gateway"

    networks:
      - sdg-dev-network

    restart: unless-stopped

    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import redis; redis.Redis(host='redis', port=6379, password='${REDIS_PASSWORD:-devpassword}').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Named volumes for data persistence
# These volumes persist data even when containers are stopped, removed, or recreated
# To completely reset data: docker-compose -f deploy/docker-compose.dev.yml down -v
volumes:
  postgres_dev_data:
    driver: local
    name: sdg-postgres-dev-data
  qdrant_dev_storage:
    driver: local
    name: sdg-qdrant-dev-storage
  qdrant_dev_snapshots:
    driver: local
    name: sdg-qdrant-dev-snapshots
  redis_dev_data:
    driver: local
    name: sdg-redis-dev-data

networks:
  sdg-dev-network:
    driver: bridge
    name: sdg-dev-network
